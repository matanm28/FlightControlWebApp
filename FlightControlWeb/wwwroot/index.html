<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script type="text/javascript">
        var markerDict = {};
        $(document).ready(function () {
            //getFlights();
            // Delete row on delete button click
            //$(document).on("click",
            //    ".delete",
            //    deleteFlight());

        });

        function deleteFlight(x) {
            var row = x.parentNode.parentNode;
            var id = row.cells[0].innerHTML;
            $.ajax({
                type: "DELETE",
                url: "api/Flights/" + id,
                success: function () {
                    //delete from map
                    row.remove();
                    $(".add-new").removeAttr("disabled");
                    map.removeLayer(markerDict[id]);
                },
                error: function () {
                    alert("failed to delete flight: " + id);
                }
            });
        }

        function getFlights(datetime) {
            var relativeTime = datetime + ":00Z";
            $.ajax({
                type: "GET",
                url: "api/Flights?relative_to=" + relativeTime + "&sync_all",
                success: addToTable,
                error: function () {
                    alert("Failed getting flights");
                }
            });
        }

        function addToTable(flights) {
            //delete all former flights
            initialTablesAndMarkers();
            flights.forEach(function (flight) {
                addToMap(flight);
                if (!flight.is_external) {
                    $('#my_flights').append('<tr id=' + flight.flight_id +' onclick="popupFlightDetails(id)"><td>' +
                        flight.flight_id +
                        '</td><td>' +
                        flight.company_name +
                        '</td><td><a class="delete" title="Delete" data-toggle="tooltip" style="color: black" onclick="deleteFlight(this)"><i class="fas fa-trash"></i></a></td>');
                } else {
                    $('#external_flights').append('<tr><td>' + flight.flight_Id + '</td><td>' + flight.company_name);
                }
            });
        }

        function popupFlightDetails(id) {
            alert("in here");
            var marker = markerDict[id];
            marker.togglePopup();
        }

        function initialTablesAndMarkers() {
            var count = document.getElementById("my_flights").rows.length;
            for (i = 1; i < count; i++) {
                document.getElementById("my_flights").deleteRow(i);
            }
            var count = document.getElementById("external_flights").rows.length;
            for (i = 1; i < count; i++) {
                document.getElementById("external_flights").deleteRow(i);
            }
            for (var id in markerDict) {
                map.removeLayer(markerDict[id]);
            }
        }

        function addToMap(flight) {
            var plainIcon = L.icon({
                iconUrl: 'custom-plane-icon.png',
                iconSize: [46, 20],
                iconAnchor: [23, 10],
                popupAnchor: [0, -10]
            });
            var marker = L.marker([flight.latitude, flight.longitude], { icon: plainIcon });
            marker.on("click", prePopupFlightDetails);
            marker.addTo(map);
            //marker.bindPopup(flight.flight_id);
            marker.bindPopup(
                "<b><strong>Flight Details<br>flight id:</strong> " +
                flight.flight_id +
                "<br><strong>passengers:</strong> " +
                flight.passengers +
                "<br><strong>company name:</strong> " + flight.company_name +
                "<br><strong>date time:</strong> " + flight.date_time + "<br><strong>is external:</strong> " +
                flight.is_external +
                "</b>");
            markerDict[flight.flight_id] = marker;
        }

        function getKeyByValue(dict, value) {
            return Object.keys(dict).find(key => dict[key] == value);

        }

        function prePopupFlightDetails(e) {
            var id = getKeyByValue(markerDict, e.sourceTarget.dragging._marker);
            popupFlightDetails(id);
            e.sourceTarget.dragging._marker.togglePopup();
        }

    </script>
    <style>
        div.twoTables {
            width: 95px;
            height: 450px;
            overflow: auto;
        }

        body {
            background-image: url('flight.jpg');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
        }

        .fa-trash:hover {
            color: red;
        }
    </style>
</head>
<body>
<div class="row">
        <div class="col-8" style="color: whitesmoke">
            <h1 style="font-size: 52px; font-family: unset">Flights Control </h1>
            <h2 style="font-size: 15px; font-family: initial">Matan Malka & Sapir Graffi </h2>
        </div>
        <div class="container col-4">
            <div>
                <label for="datetime">Enter relative date and time flights:</label>
                <input type="datetime-local" id="datetime" name="datetime">
                <input type="submit" onclick="getFlights(datetime.value)">
            </div>
        </div>
</div>
<div class="row">
    <div id="map" class="col-7">
        <script>
            //crate map 51.505, -0.09
            var map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://api.maptiler.com/maps/basic-4326/256/{z}/{x}/{y}.png?key=kUaqUXbYZJZLOhn9aaIH',
                {
                    attribution:
                        '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>'
                }).addTo(map);
            //create plains
            var plainIcon = L.icon({
                iconUrl: 'custom-plane-icon.png',
                iconSize: [95, 40],
                iconAnchor: [51.5, -0.11]
            });
            var marker = L.marker([51.5, -0.11], { icon: plainIcon }).addTo(map);
            marker.bindPopup(
                "<b>Flight Details<br>flight id:<br>longitude:<br>latitude:<br>passengers:<br>company name:<br>date time:<br>is external:</b>");
        </script>
    </div>
    <div class="twoTables col-md-5">
        <table class="twoRows">
            <tr>
                <h2>My Flights</h2>
                <table class="table table-bordered table-striped table-hover" id="my_flights">
                    <thead>
                    <tr>
                        <th>Fight id</th>
                        <th>Company Name</th>
                        <th>Delete</th>
                    </tr>
                    </thead>
                </table>
            </tr>
            <tr>
                <h2>External Flights</h2>
                <table class="table table-bordered table-striped table-hover" id="external_flights">
                    <thead>
                    <tr>
                        <th>Flight id</th>
                        <th>Company Name</th>
                    </tr>
                    </thead>
                </table>
            </tr>
        </table>

    </div>
</div>

</body>
</html >